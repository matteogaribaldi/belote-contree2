<div class="game-container" *ngIf="gameState">
  <!-- Header con punteggi -->
  <div class="game-header">
    <div class="score-panel">
      <div class="team-score" [class.my-team]="isMyTeam('northSouth')">
        <h3>{{ getTeamNames('northSouth') }}</h3>
        <div class="score">{{ gameState.gameScore.northSouth }} <small class="target-score">/ {{ gameState.targetScore }}</small></div>
        <small class="hand-score" *ngIf="!gameState.biddingPhase">(Mano: {{ gameState.score.northSouth }})</small>
      </div>
      <div class="contract-info" *ngIf="gameState.contract">
        <div class="trump-display">
          <span *ngIf="!gameState.contract.isSans" [class]="getCardClass({suit: gameState.trump})">
            {{ getSuitSymbol(gameState.trump) }}
          </span>
          <span *ngIf="gameState.contract.isSans" class="sans-atout">SA</span>
        </div>
        <div class="contract-details">
          <span *ngIf="gameState.contract.isSans">Sans Atout</span>
          <span *ngIf="!gameState.contract.isSans">{{ getSuitName(gameState.trump) }}</span>
        </div>
      </div>
      <div class="team-score" [class.my-team]="isMyTeam('eastWest')">
        <h3>{{ getTeamNames('eastWest') }}</h3>
        <div class="score">{{ gameState.gameScore.eastWest }} <small class="target-score">/ {{ gameState.targetScore }}</small></div>
        <small class="hand-score" *ngIf="!gameState.biddingPhase">(Mano: {{ gameState.score.eastWest }})</small>
      </div>
    </div>
  </div>

  <!-- Timer bar -->
  <div class="turn-timer-container" *ngIf="!gameState.gameOver">
    <div class="timer-label">
      <span *ngIf="isMyTurn()" class="my-turn">È il tuo turno!</span>
      <span *ngIf="!isMyTurn()">Turno di {{ getPositionLabel(gameState.currentPlayer) }}</span>
    </div>
    <div class="timer-bar-wrapper"
         [class.warning]="timerPercentage < 50 && timerPercentage >= 25"
         [class.critical]="timerPercentage < 25">
      <div class="timer-bar"
           [style.width.%]="100 - timerPercentage">
      </div>
    </div>
  </div>

  <!-- Fase di puntata - Round 1: Prendi/Passo -->
  <div class="bidding-phase" *ngIf="isRound1Bidding()">
    <h2>Fase di Puntata - Round 1</h2>

    <!-- Face-up card display -->
    <div class="face-up-card-container" *ngIf="gameState.faceUpCard">
      <h3>Carta Scoperta</h3>
      <div class="face-up-card">
        <div class="card"
             [class.red]="gameState.faceUpCard.suit === 'hearts' || gameState.faceUpCard.suit === 'diamonds'"
             [class.black]="gameState.faceUpCard.suit === 'clubs' || gameState.faceUpCard.suit === 'spades'">
          <div class="card-rank">{{ gameState.faceUpCard.rank }}</div>
          <div class="card-suit">{{ getSuitSymbol(gameState.faceUpCard.suit) }}</div>
        </div>
      </div>
    </div>

    <div class="bids-history" *ngIf="gameState.bids.length > 0">
      <h3>Puntate:</h3>
      <div class="bid-list">
        <div class="bid-item" *ngFor="let bidEntry of gameState.bids">
          <strong [class.team-ns]="bidEntry.player === 'north' || bidEntry.player === 'south'"
                  [class.team-ew]="bidEntry.player === 'east' || bidEntry.player === 'west'">
            {{ getPositionLabel(bidEntry.player) }}:
          </strong>
          <span *ngIf="bidEntry.bid.type === 'pass'">Passo</span>
          <span *ngIf="bidEntry.bid.type === 'take'">Prendi</span>
        </div>
      </div>
    </div>

    <div class="bidding-actions" *ngIf="isMyTurn()">
      <h3>È il tuo turno!</h3>
      <div class="round1-buttons">
        <button class="btn-take" (click)="placeBid('take')">
          Prendi
        </button>
        <button class="btn-pass" (click)="placeBid('pass')">
          Passo
        </button>
      </div>
    </div>

    <div class="waiting-bid" *ngIf="!isMyTurn()">
      <p>Turno di:
        <strong [class.team-ns]="gameState.currentPlayer === 'north' || gameState.currentPlayer === 'south'"
                [class.team-ew]="gameState.currentPlayer === 'east' || gameState.currentPlayer === 'west'">
          {{ getPositionLabel(gameState.currentPlayer) }}
        </strong>
      </p>
      <div class="loader"></div>
    </div>

    <div class="player-hand-bidding">
      <h3>Le tue carte</h3>
      <div class="cards">
        <div
          *ngFor="let card of gameState.hand; let i = index"
          class="card"
          [class.red]="card.suit === 'hearts' || card.suit === 'diamonds'"
          [class.black]="card.suit === 'clubs' || card.suit === 'spades'"
        >
          <div class="card-rank">{{ card.rank }}</div>
          <div class="card-suit">{{ getSuitSymbol(card.suit) }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fase di puntata - Round 2: Scelta seme o Sans -->
  <div class="bidding-phase" *ngIf="isRound2Bidding()">
    <h2>Fase di Puntata - Round 2</h2>

    <!-- Face-up card display -->
    <div class="face-up-card-container" *ngIf="gameState.faceUpCard">
      <h3>Carta Scoperta</h3>
      <div class="face-up-card">
        <div class="card"
             [class.red]="gameState.faceUpCard.suit === 'hearts' || gameState.faceUpCard.suit === 'diamonds'"
             [class.black]="gameState.faceUpCard.suit === 'clubs' || gameState.faceUpCard.suit === 'spades'">
          <div class="card-rank">{{ gameState.faceUpCard.rank }}</div>
          <div class="card-suit">{{ getSuitSymbol(gameState.faceUpCard.suit) }}</div>
        </div>
      </div>
    </div>

    <div class="bids-history" *ngIf="gameState.bids.length > 0">
      <h3>Puntate:</h3>
      <div class="bid-list">
        <div class="bid-item" *ngFor="let bidEntry of gameState.bids">
          <strong [class.team-ns]="bidEntry.player === 'north' || bidEntry.player === 'south'"
                  [class.team-ew]="bidEntry.player === 'east' || bidEntry.player === 'west'">
            {{ getPositionLabel(bidEntry.player) }}:
          </strong>
          <span *ngIf="bidEntry.bid.action === 'pass'">Passo</span>
          <span *ngIf="bidEntry.bid.action === 'take'">Prendi</span>
          <span *ngIf="bidEntry.bid.action === 'suit'">
            <span [class]="getCardClass({suit: bidEntry.bid.suit})">
              {{ getSuitSymbol(bidEntry.bid.suit) }}
            </span>
          </span>
          <span *ngIf="bidEntry.bid.action === 'sans'">Sans Atout</span>
        </div>
      </div>
    </div>

    <div class="bidding-actions" *ngIf="isMyTurn()">
      <h3>È il tuo turno! Scegli il seme</h3>

      <div class="suit-selection">
        <button
          *ngFor="let suit of ['hearts', 'diamonds', 'clubs', 'spades']"
          class="btn-suit"
          [class]="getCardClass({suit: suit})"
          (click)="placeBid('suit', suit)"
        >
          {{ getSuitSymbol(suit) }} {{ getSuitName(suit) }}
        </button>
      </div>

      <button class="btn-sans" (click)="placeBid('sans')">
        Sans Atout
      </button>

      <button class="btn-pass" (click)="placeBid('pass')">
        Passo
      </button>
    </div>

    <div class="waiting-bid" *ngIf="!isMyTurn()">
      <p>Turno di:
        <strong [class.team-ns]="gameState.currentPlayer === 'north' || gameState.currentPlayer === 'south'"
                [class.team-ew]="gameState.currentPlayer === 'east' || gameState.currentPlayer === 'west'">
          {{ getPositionLabel(gameState.currentPlayer) }}
        </strong>
      </p>
      <div class="loader"></div>
    </div>

    <div class="player-hand-bidding">
      <h3>Le tue carte</h3>
      <div class="cards">
        <div
          *ngFor="let card of gameState.hand; let i = index"
          class="card"
          [class.red]="card.suit === 'hearts' || card.suit === 'diamonds'"
          [class.black]="card.suit === 'clubs' || card.suit === 'spades'"
        >
          <div class="card-rank">{{ card.rank }}</div>
          <div class="card-suit">{{ getSuitSymbol(card.suit) }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fase di gioco -->
  <div class="playing-phase" *ngIf="!gameState.biddingPhase">
    <!-- Declarations display after first trick -->
    <div class="declarations-banner" *ngIf="shouldShowDeclarations()">
      <h3>Dichiarazioni</h3>
      <p>{{ getDeclarationsText() }}</p>
    </div>

    <!-- Tavolo di gioco -->
    <div class="game-table">
      <!-- Trick corrente -->
      <div class="trick-area">
        <!-- Fumetti separati (sopra le carte) -->
        <div
          *ngFor="let position of ['north', 'east', 'south', 'west']"
          class="speech-bubble-container"
          [class]="'position-' + position"
        >
          <div
            class="speech-bubble"
            *ngIf="shouldShowSpeechBubble(position)"
            [class.with-image]="gameState.lastSpeechBubble?.isJackOfTrump || gameState.lastSpeechBubble?.isNineOfTrump"
            [class.belote-bubble]="gameState.lastSpeechBubble?.isBelote || gameState.lastSpeechBubble?.isRebelote"
          >
            <picture *ngIf="gameState.lastSpeechBubble?.isJackOfTrump">
              <source srcset="assets/Subject.webp" type="image/webp">
              <img
                src="assets/Subject.png"
                alt="Jack of Trump"
                class="subject-img-bubble"
              >
            </picture>
            <picture *ngIf="gameState.lastSpeechBubble?.isNineOfTrump">
              <source srcset="assets/lory.webp" type="image/webp">
              <img
                src="assets/lory.png"
                alt="Nine of Trump"
                class="subject-img-bubble"
              >
            </picture>
            <span *ngIf="!gameState.lastSpeechBubble?.isJackOfTrump && !gameState.lastSpeechBubble?.isNineOfTrump">
              {{ gameState.lastSpeechBubble?.message }}
            </span>
          </div>
        </div>

        <!-- Carte -->
        <div
          *ngFor="let position of ['north', 'east', 'south', 'west']"
          class="trick-card"
          [class.top]="position === 'north'"
          [class.bottom]="position === 'south'"
          [class.left]="position === 'west'"
          [class.right]="position === 'east'"
          [class.visible]="gameState.currentTrick[position]"
          [class.winning-card]="isWinningCard(position)"
          [class.collecting]="collectingTrick"
        >
          <div class="card" *ngIf="gameState.currentTrick[position]"
               [class.red]="gameState.currentTrick[position].suit === 'hearts' || gameState.currentTrick[position].suit === 'diamonds'"
               [class.black]="gameState.currentTrick[position].suit === 'clubs' || gameState.currentTrick[position].suit === 'spades'">
            <div class="card-rank">{{ gameState.currentTrick[position].rank }}</div>
            <div class="card-suit">{{ getSuitSymbol(gameState.currentTrick[position].suit) }}</div>
          </div>
          <div class="position-indicator" [class.current-turn]="position === gameState.currentPlayer" [class.my-position]="position === gameState.position">
            <span *ngIf="isDealer(position)" class="dealer-badge">D</span>
            {{ getPositionLabel(position) }}
          </div>
        </div>
      </div>

      <!-- Ultimo trick -->
      <div class="last-trick" *ngIf="gameState.lastTrick">
        <button class="btn-show-last" onclick="this.nextElementSibling.classList.toggle('visible')">
          Mostra ultimo trick
        </button>
        <div class="last-trick-cards">
          <p>Vincitore: {{ getPositionLabel(gameState.lastTrick.winner) }} ({{ gameState.lastTrick.points }} punti)</p>
          <div class="mini-cards">
            <div *ngFor="let position of ['north', 'east', 'south', 'west']" class="mini-card-wrapper">
              <div class="mini-card" *ngIf="gameState.lastTrick[position]" [class]="getCardClass(gameState.lastTrick[position])">
                {{ gameState.lastTrick[position].rank }}{{ getSuitSymbol(gameState.lastTrick[position].suit) }}
              </div>
              <small>{{ getPositionLabel(position) }}</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mano del giocatore -->
    <div class="player-hand">
      <h3>La tua mano</h3>
      <div class="cards">
        <div
          *ngFor="let card of gameState.hand; let i = index"
          class="card"
          [class.red]="card.suit === 'hearts' || card.suit === 'diamonds'"
          [class.black]="card.suit === 'clubs' || card.suit === 'spades'"
          [class.playable]="isMyTurn()"
          (click)="playCard(card)"
        >
          <div class="card-rank">{{ card.rank }}</div>
          <div class="card-suit">{{ getSuitSymbol(card.suit) }}</div>
        </div>
      </div>
      <p class="turn-indicator" *ngIf="isMyTurn()">✨ È il tuo turno! Gioca una carta.</p>
      <p class="turn-indicator" *ngIf="!isMyTurn()">
        Turno di: <strong>{{ getPositionLabel(gameState.currentPlayer) }}</strong>
      </p>
    </div>

    <!-- Belote-Rebelote -->
    <div class="belote-notice" *ngIf="gameState.beloteRebelote?.announced">
      🎉 Belote-Rebelote! +20 punti
    </div>
  </div>

  <!-- Fine mano -->
  <div class="hand-complete" *ngIf="gameState.handComplete && !gameState.gameOver">
    <div class="final-score-card">
      <h2>Mano Completata!</h2>

      <div class="final-scores">
        <div class="final-team">
          <h3>{{ getTeamNames('northSouth') }}</h3>
          <div class="final-points">+{{ gameState.finalScore.northSouth }}</div>
          <small>Totale: {{ gameState.gameScore.northSouth }}</small>
        </div>
        <div class="final-team">
          <h3>{{ getTeamNames('eastWest') }}</h3>
          <div class="final-points">+{{ gameState.finalScore.eastWest }}</div>
          <small>Totale: {{ gameState.gameScore.eastWest }}</small>
        </div>
      </div>

      <div class="contract-result">
        <p *ngIf="isContractRespected()">
          ✅ Contratto rispettato!
        </p>
        <p *ngIf="!isContractRespected()">
          ❌ Contratto fallito!
        </p>
      </div>

      <!-- Sezione carte iniziali espandibile -->
      <div class="initial-hands-section">
        <button class="btn-toggle-hands" (click)="showInitialHands = !showInitialHands">
          {{ showInitialHands ? '▼' : '▶' }} Mostra carte iniziali
        </button>

        <div class="initial-hands-grid" *ngIf="showInitialHands && gameState.initialHands">
          <div class="player-hand-display" *ngFor="let pos of ['north', 'east', 'south', 'west']">
            <h4>{{ getPositionLabel(pos) }}</h4>
            <div class="cards-by-suit">
              <div class="suit-row" *ngFor="let suit of ['hearts', 'diamonds', 'clubs', 'spades']">
                <span class="suit-symbol" [ngClass]="suit">{{ getSuitSymbol(suit) }}</span>
                <span class="cards-list">{{ getCardsForSuit(gameState.initialHands[pos], suit) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <button class="btn-new-hand" (click)="nextHand()">
        Nuova Mano
      </button>
    </div>
  </div>

  <!-- Fine partita - Vittoria -->
  <div class="game-over" *ngIf="gameState.gameOver">
    <div class="victory-card">
      <h1>🎉 Partita Terminata! 🎉</h1>

      <div class="victory-image">
        <img src="/img/Subject.png" alt="Victory" class="subject-img">
      </div>

      <div class="winner-announcement-big">
        <h2>Vincitori:</h2>
        <h3 class="winner-team">{{ getWinnerTeamName() }}</h3>
      </div>

      <div class="final-game-scores">
        <div class="final-team" [class.winner]="gameState.winner === 'northSouth'">
          <h3>{{ getTeamNames('northSouth') }}</h3>
          <div class="final-points">{{ gameState.gameScore.northSouth }}</div>
        </div>
        <div class="final-team" [class.winner]="gameState.winner === 'eastWest'">
          <h3>{{ getTeamNames('eastWest') }}</h3>
          <div class="final-points">{{ gameState.gameScore.eastWest }}</div>
        </div>
      </div>

      <div class="hand-history" *ngIf="gameState.handHistory && gameState.handHistory.length > 0">
        <h3>Storico Mani</h3>
        <div class="history-list">
          <div class="history-item" *ngFor="let hand of gameState.handHistory">
            <span class="hand-number">Mano {{ hand.handNumber }}</span>
            <span class="hand-contract">
              <span *ngIf="hand.contract.isSans">Sans</span>
              <span *ngIf="!hand.contract.isSans">{{ getSuitSymbol(hand.contract.suit) }}</span>
            </span>
            <span class="hand-scores">{{ hand.finalScore.northSouth }} - {{ hand.finalScore.eastWest }}</span>
          </div>
        </div>
      </div>

      <button class="btn-home" (click)="goHome()">
        Torna alla Home
      </button>
    </div>
  </div>

  <!-- Winner announcement -->
  <div class="winner-announcement" *ngIf="showWinnerAnnouncement">
    <div class="winner-name">{{ getPositionLabel(gameState.lastTrick?.winner) }}</div>
    <div class="winner-points">+{{ gameState.lastTrick?.points }} punti</div>
  </div>
</div>
