<div class="game-container" *ngIf="gameState">
  <!-- Header con punteggi -->
  <div class="game-header">
    <button class="btn-close-room" (click)="closeRoom()">
      Chiudi Tavolo
    </button>
    <div class="score-panel">
      <div class="team-score" [class.my-team]="isMyTeam('northSouth')">
        <h3>{{ getTeamNames('northSouth') }}</h3>
        <div class="score">{{ gameState.gameScore.northSouth }} <span class="target-score">/ {{ gameState.targetScore }}</span></div>
        <small class="hand-score" *ngIf="!gameState.biddingPhase">(Mano: {{ gameState.score.northSouth }})</small>
      </div>
      <div class="contract-info" *ngIf="gameState.contract">
        <div class="trump">
          Atout: <span [class]="getCardClass({suit: gameState.trump})">
            {{ getSuitSymbol(gameState.trump) }} {{ getSuitName(gameState.trump) }}
          </span>
        </div>
        <div class="contract-details">
          <span *ngIf="gameState.contract.bid.type === 'cappotto'">
            Contratto: Cappotto (500 punti)
          </span>
          <span *ngIf="gameState.contract.bid.type !== 'cappotto'">
            Contratto: {{ gameState.contract.bid.points }} punti
          </span>
          <br>
          <small>{{ getPositionLabel(gameState.contract.player) }}</small>
        </div>
      </div>
      <div class="team-score" [class.my-team]="isMyTeam('eastWest')">
        <h3>{{ getTeamNames('eastWest') }}</h3>
        <div class="score">{{ gameState.gameScore.eastWest }} <span class="target-score">/ {{ gameState.targetScore }}</span></div>
        <small class="hand-score" *ngIf="!gameState.biddingPhase">(Mano: {{ gameState.score.eastWest }})</small>
      </div>
    </div>
  </div>

  <!-- Timer bar -->
  <div class="turn-timer-container" *ngIf="!gameState.gameOver">
    <div class="timer-label">
      <span *ngIf="isMyTurn()" class="my-turn">√à il tuo turno!</span>
      <span *ngIf="!isMyTurn()">Turno di {{ getPositionLabel(gameState.currentPlayer) }}</span>
    </div>
    <div class="timer-bar-wrapper"
         [class.warning]="timerPercentage < 50 && timerPercentage >= 25"
         [class.critical]="timerPercentage < 25">
      <div class="timer-bar"
           [style.width.%]="100 - timerPercentage">
      </div>
    </div>
  </div>

  <!-- Fase di puntata -->
  <div class="bidding-phase" *ngIf="gameState.biddingPhase">
    <h2>Fase di Puntata</h2>
    
    <div class="bids-history" *ngIf="gameState.bids.length > 0">
      <h3>Puntate:</h3>
      <div class="bid-list">
        <div class="bid-item" *ngFor="let bidEntry of gameState.bids">
          <strong [class.team-ns]="bidEntry.player === 'north' || bidEntry.player === 'south'"
                  [class.team-ew]="bidEntry.player === 'east' || bidEntry.player === 'west'">
            <span *ngIf="isDealer(bidEntry.player)" class="dealer-badge">D</span>
            <span *ngIf="isFirstHand(bidEntry.player)" class="first-hand-badge">F</span>
            {{ getPositionLabel(bidEntry.player) }}:
          </strong>
          <span *ngIf="bidEntry.bid.type === 'pass'">Passo</span>
          <span *ngIf="bidEntry.bid.type === 'bid'">
            {{ bidEntry.bid.points }} -
            <span [class]="getCardClass({suit: bidEntry.bid.suit})">
              {{ getSuitSymbol(bidEntry.bid.suit) }}
            </span>
          </span>
          <span *ngIf="bidEntry.bid.type === 'cappotto'" class="cappotto-badge">
            Cappotto (500) -
            <span [class]="getCardClass({suit: bidEntry.bid.suit})">
              {{ getSuitSymbol(bidEntry.bid.suit) }}
            </span>
          </span>
          <span *ngIf="bidEntry.bid.type === 'contro'" class="contro-badge">Contro</span>
          <span *ngIf="bidEntry.bid.type === 'surcontre'" class="surcontre-badge">Surcontre</span>
        </div>
      </div>
    </div>

    <div class="bidding-actions" *ngIf="isMyTurn()">
      <h3>√à il tuo turno!</h3>
      <p class="first-hand-notice" *ngIf="isFirstHand(gameState.position)">
        üéØ Sei il primo di mano!
      </p>

      <div *ngIf="!selectedBid" class="suit-selection">
        <button
          *ngFor="let suit of ['hearts', 'diamonds', 'clubs', 'spades']"
          class="btn-suit"
          [class]="getCardClass({suit: suit})"
          (click)="selectBidSuit(suit)"
        >
          {{ getSuitSymbol(suit) }} {{ getSuitName(suit) }}
        </button>
      </div>

      <div *ngIf="selectedBid" class="points-selection">
        <h4>
          Seme selezionato:
          <span [class]="getCardClass({suit: selectedBid.suit})">
            {{ getSuitSymbol(selectedBid.suit) }}
          </span>
        </h4>
        <div class="points-grid">
          <button
            *ngFor="let points of bidPoints"
            class="btn-points"
            [class.btn-cappotto]="isCappotto(points)"
            [disabled]="!canBidPoints(points)"
            (click)="isCappotto(points) ? placeBid('cappotto', selectedBid.suit) : placeBid('bid', selectedBid.suit, points)"
          >
            {{ getPointsLabel(points) }}
          </button>
        </div>
        <button class="btn-back" (click)="selectedBid = null">Indietro</button>
      </div>

      <div class="special-bids">
        <button
          class="btn-contro"
          *ngIf="canContro()"
          (click)="placeContro()"
        >
          Contro
        </button>
        <button
          class="btn-surcontre"
          *ngIf="canSurcontre()"
          (click)="placeSurcontre()"
        >
          Surcontre
        </button>
      </div>

      <button class="btn-pass" (click)="placeBid('pass')">
        Passo
      </button>
    </div>

    <div class="waiting-bid" *ngIf="!isMyTurn()">
      <p>Turno di:
        <strong [class.team-ns]="gameState.currentPlayer === 'north' || gameState.currentPlayer === 'south'"
                [class.team-ew]="gameState.currentPlayer === 'east' || gameState.currentPlayer === 'west'">
          <span *ngIf="isDealer(gameState.currentPlayer)" class="dealer-badge">D</span>
          <span *ngIf="isFirstHand(gameState.currentPlayer)" class="first-hand-badge">F</span>
          {{ getPositionLabel(gameState.currentPlayer) }}
        </strong>
      </p>
      <div class="loader"></div>
    </div>
    <div class="player-hand-bidding">
      <h3>Le tue carte</h3>
      <div class="cards">
        <div
          *ngFor="let card of gameState.hand; let i = index"
          class="card"
          [class.red]="card.suit === 'hearts' || card.suit === 'diamonds'"
          [class.black]="card.suit === 'clubs' || card.suit === 'spades'"
        >
          <div class="card-rank">{{ card.rank }}</div>
          <div class="card-suit">{{ getSuitSymbol(card.suit) }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTINUA NELLA PARTE 2... -->
   <!-- Fase di gioco -->
  <div class="playing-phase" *ngIf="!gameState.biddingPhase">
    <!-- Tavolo di gioco -->
    <div class="game-table">
      <!-- Trick corrente -->
      <div class="trick-area">
        <!-- Fumetti separati (sopra le carte) -->
        <div
          *ngFor="let position of ['north', 'east', 'south', 'west']"
          class="speech-bubble-container"
          [class]="'position-' + position"
        >
          <div
            class="speech-bubble"
            *ngIf="shouldShowSpeechBubble(position)"
            [class.belote-bubble]="gameState.lastSpeechBubble?.isBelote || gameState.lastSpeechBubble?.isRebelote"
          >
            {{ gameState.lastSpeechBubble?.message }}
          </div>
        </div>

        <!-- Carte -->
        <div
          *ngFor="let position of ['north', 'east', 'south', 'west']"
          class="trick-card"
          [class.top]="position === 'north'"
          [class.bottom]="position === 'south'"
          [class.left]="position === 'west'"
          [class.right]="position === 'east'"
          [class.visible]="gameState.currentTrick[position]"
          [class.winning-card]="isWinningCard(position)"
          [class.collecting]="collectingTrick"
        >
          <div class="card" *ngIf="gameState.currentTrick[position]"
               [class.red]="gameState.currentTrick[position].suit === 'hearts' || gameState.currentTrick[position].suit === 'diamonds'"
               [class.black]="gameState.currentTrick[position].suit === 'clubs' || gameState.currentTrick[position].suit === 'spades'">
            <div class="card-rank">{{ gameState.currentTrick[position].rank }}</div>
            <div class="card-suit">{{ getSuitSymbol(gameState.currentTrick[position].suit) }}</div>
          </div>
          <div class="position-indicator" [class.current-turn]="position === gameState.currentPlayer" [class.my-position]="position === gameState.position">
            <span *ngIf="isDealer(position)" class="dealer-badge">D</span>
            {{ getPositionLabel(position) }}
          </div>
        </div>
      </div>

      <!-- Ultimo trick -->
      <div class="last-trick" *ngIf="gameState.lastTrick">
        <button class="btn-show-last" onclick="this.nextElementSibling.classList.toggle('visible')">
          Mostra ultimo trick
        </button>
        <div class="last-trick-cards">
          <p>Vincitore: {{ getPositionLabel(gameState.lastTrick.winner) }} ({{ gameState.lastTrick.points }} punti)</p>
          <div class="mini-cards">
            <div *ngFor="let position of ['north', 'east', 'south', 'west']" class="mini-card-wrapper">
              <div class="mini-card" *ngIf="gameState.lastTrick[position]" [class]="getCardClass(gameState.lastTrick[position])">
                {{ gameState.lastTrick[position].rank }}{{ getSuitSymbol(gameState.lastTrick[position].suit) }}
              </div>
              <small>{{ getPositionLabel(position) }}</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mano del giocatore -->
    <div class="player-hand">
      <h3>La tua mano</h3>
      <div class="cards">
        <div
          *ngFor="let card of gameState.hand; let i = index"
          class="card"
          [class.red]="card.suit === 'hearts' || card.suit === 'diamonds'"
          [class.black]="card.suit === 'clubs' || card.suit === 'spades'"
          [class.playable]="isMyTurn() && isCardPlayable(card)"
          [class.unplayable]="isMyTurn() && !isCardPlayable(card)"
          (click)="isCardPlayable(card) ? playCard(card) : null"
        >
          <div class="card-rank">{{ card.rank }}</div>
          <div class="card-suit">{{ getSuitSymbol(card.suit) }}</div>
        </div>
      </div>

      <!-- Bottone dichiarazione Belote -->
      <button class="btn-belote" (click)="declareBelote()" *ngIf="!gameState.biddingPhase">
        Dichiara Belote
      </button>

      <p class="turn-indicator" *ngIf="isMyTurn()">‚ú® √à il tuo turno! Gioca una carta.</p>
      <p class="turn-indicator" *ngIf="!isMyTurn()">
        Turno di: <strong>{{ getPositionLabel(gameState.currentPlayer) }}</strong>
      </p>
    </div>

    <!-- Belote-Rebelote -->
    <div class="belote-notice" *ngIf="showBelotePopup" @fadeInOut>
      üéâ Belote-Rebelote! +20 punti
    </div>
  </div>

  <!-- Fine mano -->
  <div class="hand-complete" *ngIf="gameState.handComplete && !gameState.gameOver">
    <div class="final-score-card">
      <h2>Mano Completata!</h2>

      <div class="final-scores">
        <div class="final-team">
          <h3>{{ getTeamNames('northSouth') }}</h3>
          <div class="final-points">+{{ gameState.finalScore.northSouth }}</div>
          <small>Totale: {{ gameState.gameScore.northSouth }}</small>
        </div>
        <div class="final-team">
          <h3>{{ getTeamNames('eastWest') }}</h3>
          <div class="final-points">+{{ gameState.finalScore.eastWest }}</div>
          <small>Totale: {{ gameState.gameScore.eastWest }}</small>
        </div>
      </div>

      <div class="contract-result">
        <p *ngIf="isContractRespected()">
          ‚úÖ Contratto rispettato!
        </p>
        <p *ngIf="!isContractRespected()">
          ‚ùå Contratto fallito!
        </p>
      </div>

      <!-- Sezione carte iniziali espandibile -->
      <div class="initial-hands-section">
        <button class="btn-toggle-hands" (click)="showInitialHands = !showInitialHands">
          {{ showInitialHands ? '‚ñº' : '‚ñ∂' }} Mostra carte iniziali
        </button>

        <div class="initial-hands-grid" *ngIf="showInitialHands && gameState.initialHands">
          <div class="player-hand-display" *ngFor="let pos of ['north', 'east', 'south', 'west']">
            <h4>{{ getPositionLabel(pos) }}</h4>
            <div class="cards-by-suit">
              <div class="suit-row" *ngFor="let suit of ['hearts', 'diamonds', 'clubs', 'spades']">
                <span class="suit-symbol" [ngClass]="suit">{{ getSuitSymbol(suit) }}</span>
                <span class="cards-list">{{ getCardsForSuit(gameState.initialHands[pos], suit) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <button class="btn-new-hand" (click)="nextHand()">
        Nuova Mano
      </button>
    </div>
  </div>

  <!-- Fine partita - Vittoria a 701 -->
  <div class="game-over" *ngIf="gameState.gameOver">
    <div class="victory-card">
      <h1>üéâ Partita Terminata! üéâ</h1>

      <div class="victory-image">
        <img src="assets/Subject.webp" alt="Victory" class="subject-img">
      </div>

      <div class="winner-announcement-big">
        <h2>Vincitori:</h2>
        <h3 class="winner-team">{{ getWinnerTeamName() }}</h3>
      </div>

      <div class="final-game-scores">
        <div class="final-team" [class.winner]="gameState.winner === 'northSouth'">
          <h3>{{ getTeamNames('northSouth') }}</h3>
          <div class="final-points">{{ gameState.gameScore.northSouth }}</div>
        </div>
        <div class="final-team" [class.winner]="gameState.winner === 'eastWest'">
          <h3>{{ getTeamNames('eastWest') }}</h3>
          <div class="final-points">{{ gameState.gameScore.eastWest }}</div>
        </div>
      </div>

      <div class="hand-history" *ngIf="gameState.handHistory && gameState.handHistory.length > 0">
        <h3>Storico Mani</h3>
        <div class="history-list">
          <div class="history-item" *ngFor="let hand of gameState.handHistory">
            <span class="hand-number">Mano {{ hand.handNumber }}</span>
            <span class="hand-contract">
              <span *ngIf="hand.contract.bid.type !== 'cappotto'">
                {{ hand.contract.bid.points }} {{ getSuitSymbol(hand.contract.bid.suit) }}
              </span>
              <span *ngIf="hand.contract.bid.type === 'cappotto'">
                Cappotto {{ getSuitSymbol(hand.contract.bid.suit) }}
              </span>
            </span>
            <span class="hand-scores">{{ hand.finalScore.northSouth }} - {{ hand.finalScore.eastWest }}</span>
          </div>
        </div>
      </div>

      <button class="btn-home" (click)="goHome()">
        Torna alla Home
      </button>
    </div>
  </div>
  <!-- Winner announcement -->
  <div class="winner-announcement" *ngIf="showWinnerAnnouncement">
    <div class="winner-name">{{ getPositionLabel(gameState.lastTrick?.winner) }}</div>
    <div class="winner-points">+{{ gameState.lastTrick?.points }} punti</div>
  </div>
</div>
